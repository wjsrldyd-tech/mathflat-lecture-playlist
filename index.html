<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MathFlat ê°•ì˜ ê´€ë¦¬</title>
<style>
* {
  box-sizing: border-box;
}
body { 
  font-family: 'Malgun Gothic', sans-serif; 
  padding: 0;
  margin: 0;
  background: #f5f5f5;
}
.container {
  display: flex;
  gap: 0;
  height: 100vh;
}
/* ì„¸ë¡œ íƒ­ë°” ìŠ¤íƒ€ì¼ */
.vertical-tabs {
  width: 80px;
  flex-shrink: 0;
  background: #f9f9f9;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px 0;
  gap: 10px;
  box-shadow: 2px 0 4px rgba(0,0,0,0.1);
  z-index: 100;
}
.tab-btn {
  width: 60px;
  height: 60px;
  border: none;
  background: transparent;
  font-size: 24px;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.2s;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  padding: 8px;
}
.tab-btn:hover {
  background: #e0e0e0;
  transform: scale(1.05);
}
.tab-btn.active {
  background: #1a237e;
  color: white;
}
.tab-btn.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 4px;
  height: 40px;
  background: #1a237e;
  border-radius: 0 4px 4px 0;
}
.tab-label {
  font-size: 11px;
  font-weight: 500;
  line-height: 1.2;
  word-break: keep-all;
  text-align: center;
}
.tab-spacer {
  flex: 1;
}
.tab-divider {
  width: 40px;
  height: 1px;
  background: #ddd;
  margin: 10px 0;
}
/* ì„¤ì • í™”ë©´ ìŠ¤íƒ€ì¼ */
.settings-screen {
  display: none;
  flex: 1;
  min-width: 0;
  min-height: 100vh;
}
.settings-screen.active {
  display: flex;
}
/* ì„¤ì • ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
.settings-sidebar {
  width: 280px;
  flex-shrink: 0;
  background: #f9f9f9;
  border-right: 1px solid #ddd;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.settings-header {
  padding: 20px;
  border-bottom: 1px solid #ddd;
  background: #1a237e;
  color: white;
}
.settings-header h2 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}
.settings-menu {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.settings-menu-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: white;
  border: 2px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
  font-weight: 500;
  color: #333;
}
.settings-menu-item:hover {
  background: #f0f0f0;
  border-color: #1a237e;
  transform: translateX(4px);
}
.settings-menu-item.active {
  background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
  color: white;
  border-color: #1a237e;
}
.settings-menu-item span:first-child {
  font-size: 20px;
}
/* ì„¤ì • ë©”ì¸ ì½˜í…ì¸  */
.settings-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: white;
}
.settings-panel {
  display: none;
  flex: 1;
  overflow-y: auto;
  padding: 30px;
}
.settings-panel.active {
  display: block;
}
.settings-panel-header {
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e0e0e0;
}
.settings-panel-header h3 {
  margin: 0;
  font-size: 22px;
  font-weight: 600;
  color: #333;
}
.settings-panel-description {
  margin-top: 8px;
  font-size: 13px;
  color: #666;
  line-height: 1.6;
}
.settings-form-group {
  margin-bottom: 25px;
}
.settings-form-group label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #1a237e;
  margin-bottom: 10px;
}
.settings-form-group textarea {
  width: 100%;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 8px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  resize: vertical;
  box-sizing: border-box;
  transition: all 0.2s;
}
.settings-form-group textarea:focus {
  outline: none;
  border-color: #1a237e;
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}
.settings-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.left-panel {
  width: 400px;
  flex-shrink: 0;
  background: white;
  border-right: 1px solid #ddd;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.right-panel {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #000;
}
.header {
  padding: 15px;
  border-bottom: 1px solid #ddd;
  background: #f9f9f9;
}
.header-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
h2 {
  margin: 0;
  font-size: 18px;
}
.grade-selector {
  display: flex;
  gap: 5px;
  margin-bottom: 10px;
}
.grade-btn {
  padding: 5px 12px;
  border: 1px solid #ddd;
  background: white;
  border-radius: 5px;
  cursor: pointer;
  font-size: 13px;
}
.grade-btn.active {
  background: #1a237e;
  color: white;
  border-color: #1a237e;
}
.add-btn {
  padding: 8px 16px;
  background: #1a237e;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 13px;
}
.add-btn:hover {
  background: #283593;
}
.tree-container {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}
.tree-item {
  margin: 2px 0;
  user-select: none;
}
.tree-item-header {
  padding: 6px 8px;
  cursor: pointer;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 14px;
}
.tree-item-header:hover {
  background: #f0f0f0;
}
.tree-item-header.active {
  background: #e3f2fd;
  color: #1976d2;
}
.tree-toggle {
  width: 16px;
  height: 16px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #666;
}
.tree-toggle.expanded::before {
  content: 'â–¼';
}
.tree-toggle.collapsed::before {
  content: 'â–¶';
}
.tree-children {
  margin-left: 20px;
  display: none;
}
.tree-children.expanded {
  display: block;
}
.tree-icon {
  font-size: 16px;
  margin-right: 4px;
}
.type-item {
  padding: 6px 8px 6px 30px;
  cursor: pointer;
  border-radius: 4px;
  font-size: 13px;
  display: flex;
  justify-content: flex-start;
  align-items: center;
  gap: 8px;
}
.type-item:hover {
  background: #f0f0f0;
}
.type-item.active {
  background: #fff3cd;
  font-weight: 500;
}
.lecture-count {
  font-size: 11px;
  color: #666;
  background: #e0e0e0;
  padding: 2px 6px;
  border-radius: 10px;
  margin-left: auto;
}
.lecture-list {
  padding: 10px;
  background: white;
  border-top: 1px solid #ddd;
  max-height: 300px;
  overflow-y: auto;
  display: none;
}
.lecture-list.visible {
  display: block;
}
.lecture-item {
  padding: 6px 8px 6px 50px;
  margin: 2px 0;
  background: transparent;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
  color: #555;
}
.lecture-item:hover {
  background: #f0f0f0;
}
.lecture-item.playing {
  background: #fff3cd;
  font-weight: 500;
  color: #1976d2;
}
.lecture-item-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.delete-lecture-btn {
  background: #f44336;
  color: white;
  border: none;
  border-radius: 3px;
  padding: 2px 6px;
  cursor: pointer;
  font-size: 10px;
  margin-left: 8px;
  opacity: 0.7;
}
.delete-lecture-btn:hover {
  background: #da190b;
  opacity: 1;
}
#player { 
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 0;
}
video { 
  width: 100%; 
  height: 100%;
  max-height: 100%;
  object-fit: contain;
}
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background-color: #fefefe;
  margin: 10% auto;
  padding: 20px;
  border: 1px solid #888;
  border-radius: 10px;
  width: 80%;
  max-width: 600px;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}
.close {
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close:hover {
  color: #000;
}
.json-input {
  width: 100%;
  min-height: 200px;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  resize: vertical;
  box-sizing: border-box;
}
.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 15px;
}
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
}
.btn-primary {
  background: #1a237e;
  color: white;
}
.btn-primary:hover {
  background: #283593;
}
.btn-secondary {
  background: #f44336;
  color: white;
}
.btn-secondary:hover {
  background: #da190b;
}
</style>
</head>
<body>

<div class="container">
  <!-- ì„¸ë¡œ íƒ­ë°” -->
  <div class="vertical-tabs">
    <button class="tab-btn active" data-screen="lectures">
      <span>ğŸ“š</span>
      <span class="tab-label">ê°•ì˜</span>
    </button>
    <div class="tab-spacer"></div>
    <div class="tab-divider"></div>
    <button class="tab-btn" data-screen="settings">
      <span>âš™ï¸</span>
      <span class="tab-label">ì„¤ì •</span>
    </button>
  </div>
  
  <!-- ì„¤ì • í™”ë©´ -->
  <div class="settings-screen" id="settingsScreen">
    <!-- ì„¤ì • ì‚¬ì´ë“œë°” -->
    <div class="settings-sidebar">
      <div class="settings-header">
        <h2>âš™ï¸ ì„¤ì •</h2>
      </div>
      <div class="settings-menu">
        <button class="settings-menu-item active" data-setting="lecture-management">
          <span>ğŸ“š</span>
          <span>ê°•ì˜ ê´€ë¦¬</span>
        </button>
        <button class="settings-menu-item" data-setting="curriculum-edit">
          <span>ğŸ“</span>
          <span>ì»¤ë¦¬í˜ëŸ¼ í¸ì§‘</span>
        </button>
      </div>
    </div>
    
    <!-- ì„¤ì • ë©”ì¸ ì½˜í…ì¸  -->
    <div class="settings-main">
      <!-- ê°•ì˜ ê´€ë¦¬ íŒ¨ë„ -->
      <div class="settings-panel active" id="lecture-management-panel">
        <div class="settings-panel-header">
          <h3>ğŸ“š ê°•ì˜ ê´€ë¦¬</h3>
          <div class="settings-panel-description">
            ë¶ë§ˆí¬ë¦¿ìœ¼ë¡œ ë³µì‚¬í•œ JSONì„ ë¶™ì—¬ë„£ì–´ ê°•ì˜ë¥¼ ì¼ê´„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
        </div>
        
        <div class="settings-form-group">
          <label>ê°•ì˜ JSON ì…ë ¥</label>
          <textarea id="settingsJsonInput" placeholder='[{"title":"ë¬¸ì œ 123","url":"https://..."}]' style="min-height: 200px;"></textarea>
        </div>
        
        <div class="settings-actions">
          <button class="btn btn-primary" id="settingsAddBtn" style="flex: 1;">ì¶”ê°€</button>
        </div>
      </div>
      
      <!-- ì»¤ë¦¬í˜ëŸ¼ í¸ì§‘ íŒ¨ë„ -->
      <div class="settings-panel" id="curriculum-edit-panel">
        <div class="settings-panel-header">
          <h3>ğŸ“ ì»¤ë¦¬í˜ëŸ¼ í¸ì§‘</h3>
          <div class="settings-panel-description">
            í˜„ì¬ ì„ íƒëœ í•™ë…„-í•™ê¸°ì˜ ì»¤ë¦¬í˜ëŸ¼ JSONì„ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì €ì¥í•˜ë©´ localStorageì— ë°˜ì˜ë©ë‹ˆë‹¤.
          </div>
        </div>
        
        <div class="settings-form-group">
          <label>ì»¤ë¦¬í˜ëŸ¼ JSON í¸ì§‘</label>
          <textarea id="curriculumJsonInput" placeholder='{"ìˆ˜ì™€ ì‹": {...}}' style="min-height: 400px; font-family: monospace; font-size: 12px;"></textarea>
        </div>
        
        <div class="settings-actions">
          <button class="btn btn-primary" id="curriculumSaveBtn" style="flex: 1;">ì €ì¥</button>
          <button class="btn btn-secondary" id="curriculumResetBtn">ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="left-panel" id="lecturesPanel">
    <div class="header">
      <div class="header-top">
        <h2>ğŸ“š MathFlat ê°•ì˜ ê´€ë¦¬</h2>
        <button class="add-btn" id="addBtn">â• ê°•ì˜ ì¶”ê°€</button>
      </div>
      <div class="grade-selector" id="gradeSelector">
        <!-- í•™ë…„-í•™ê¸° ë²„íŠ¼ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
      </div>
    </div>
    <div class="tree-container" id="treeContainer">
      <!-- íŠ¸ë¦¬ë·°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
    </div>
  </div>
  
  <div class="right-panel" id="rightPanel">
    <div id="player">
      <video id="videoPlayer" controls></video>
    </div>
  </div>
</div>

<!-- ëª¨ë‹¬ -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ê°•ì˜ ì¶”ê°€</h3>
      <span class="close" id="closeModal">&times;</span>
    </div>
    <p>ë¶ë§ˆí¬ë¦¿ìœ¼ë¡œ ë³µì‚¬í•œ JSONì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:</p>
    <textarea id="jsonInput" class="json-input" placeholder='[{"title":"ë¬¸ì œ 123","url":"https://..."}]'></textarea>
    <div class="modal-actions">
      <button class="btn btn-secondary" id="cancelBtn">ì·¨ì†Œ</button>
      <button class="btn btn-primary" id="saveBtn">ì¶”ê°€</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
// í˜„ì¬ ì„ íƒëœ í•™ë…„-í•™ê¸°
let currentGrade = null;
let curriculumData = null;
let lecturesData = {};
let availableGrades = []; // ì‚¬ìš© ê°€ëŠ¥í•œ í•™ë…„-í•™ê¸° ëª©ë¡

// ì‚¬ìš© ê°€ëŠ¥í•œ í•™ë…„-í•™ê¸° ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
function getAvailableGrades() {
  const grades = new Set();
  
  // localStorageì—ì„œ ëª¨ë“  mathflat_* í‚¤ ì°¾ê¸°
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith('mathflat_')) {
      const grade = key.replace('mathflat_', '');
      grades.add(grade);
    }
  }
  
  // data í´ë”ì˜ JSON íŒŒì¼ ëª©ë¡ë„ í™•ì¸ (ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬)
  // ì‹¤ì œë¡œëŠ” ì„œë²„ì—ì„œ íŒŒì¼ ëª©ë¡ì„ ì œê³µí•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” localStorage ê¸°ë°˜ìœ¼ë¡œë§Œ ì²˜ë¦¬
  
  return Array.from(grades).sort();
}

// í•™ë…„-í•™ê¸° ë²„íŠ¼ ë Œë”ë§
function renderGradeButtons() {
  const selector = document.getElementById('gradeSelector');
  selector.innerHTML = '';
  
  availableGrades = getAvailableGrades();
  
  if (availableGrades.length === 0) {
    // ê¸°ë³¸ê°’ìœ¼ë¡œ ì¤‘2-1 ì¶”ê°€ (ìƒˆë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°)
    availableGrades = ['ì¤‘2-1'];
  }
  
  availableGrades.forEach(grade => {
    const btn = document.createElement('button');
    btn.className = 'grade-btn';
    btn.dataset.grade = grade;
    btn.textContent = grade;
    btn.addEventListener('click', () => {
      document.querySelectorAll('.grade-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentGrade = grade;
      loadGradeData(grade);
    });
    selector.appendChild(btn);
  });
  
  // ì²« ë²ˆì§¸ ë²„íŠ¼ì„ í™œì„±í™”í•˜ê³  ë¡œë“œ
  if (availableGrades.length > 0 && !currentGrade) {
    currentGrade = availableGrades[0];
    const firstBtn = selector.querySelector('.grade-btn');
    if (firstBtn) {
      firstBtn.classList.add('active');
      loadGradeData(currentGrade);
    }
  } else if (currentGrade) {
    // í˜„ì¬ ì„ íƒëœ í•™ë…„-í•™ê¸°ê°€ ìˆìœ¼ë©´ í™œì„±í™”
    const activeBtn = selector.querySelector(`[data-grade="${currentGrade}"]`);
    if (activeBtn) {
      activeBtn.classList.add('active');
    }
  }
}

// í•™ë…„-í•™ê¸°ë³„ ë°ì´í„° ë¡œë“œ
async function loadGradeData(grade) {
  try {
    // ë¨¼ì € localStorageì—ì„œ í™•ì¸
    const saved = localStorage.getItem(`mathflat_${grade}`);
    if (saved) {
      const data = JSON.parse(saved);
      curriculumData = data.curriculum;
      lecturesData = data.lectures || {};
      renderTree();
      return;
    }
    
    // localStorageì— ì—†ìœ¼ë©´ JSON íŒŒì¼ì—ì„œ ë¡œë“œ
    const response = await fetch(`data/${grade}.json`);
    if (!response.ok) {
      throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    const data = await response.json();
    curriculumData = data.curriculum;
    lecturesData = data.lectures || {};
    
    // localStorageì— ì €ì¥
    localStorage.setItem(`mathflat_${grade}`, JSON.stringify(data));
    
    // í•™ë…„-í•™ê¸° ëª©ë¡ ì—…ë°ì´íŠ¸ (ìƒˆë¡œ ì¶”ê°€ëœ ê²½ìš°)
    if (!availableGrades.includes(grade)) {
      availableGrades.push(grade);
      availableGrades.sort();
      renderGradeButtons();
    }
    
    renderTree();
  } catch (error) {
    console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
    alert(`${grade} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
  }
}

// íŠ¸ë¦¬ë·° ë Œë”ë§
function renderTree() {
  const container = document.getElementById('treeContainer');
  container.innerHTML = '';
  
  if (!curriculumData) return;
  
  Object.keys(curriculumData).forEach(majorUnit => {
    const majorItem = createTreeItem(majorUnit, 'major', () => {
      renderSubTree(majorItem, curriculumData[majorUnit], 'middle');
    });
    container.appendChild(majorItem);
  });
}

function createTreeItem(name, level, onClick) {
  const item = document.createElement('div');
  item.className = 'tree-item';
  
  const header = document.createElement('div');
  header.className = 'tree-item-header';
  
  const text = document.createElement('span');
  text.textContent = name;
  
  if (level === 'type') {
    // ìœ í˜• ì•„ì´í…œ: í† ê¸€ ì•„ì´ì½˜ë§Œ ì¶”ê°€
    const typeToggle = document.createElement('span');
    typeToggle.className = 'tree-toggle collapsed';
    
    const count = getLectureCount(name);
    if (count > 0) {
      const countBadge = document.createElement('span');
      countBadge.className = 'lecture-count';
      countBadge.textContent = count;
      header.appendChild(typeToggle);
      header.appendChild(text);
      header.appendChild(countBadge);
    } else {
      header.appendChild(typeToggle);
      header.appendChild(text);
    }
    
    header.classList.add('type-item');
    
    header.addEventListener('click', (e) => {
      e.stopPropagation();
      let children = item.querySelector('.tree-children');
      const isExpanded = children && children.classList.contains('expanded');
      
      if (isExpanded) {
        // ì ‘ê¸°
        children.classList.remove('expanded');
        typeToggle.classList.remove('expanded');
        typeToggle.classList.add('collapsed');
      } else {
        // í¼ì¹˜ê¸°: ì˜ìƒ ëª©ë¡ í‘œì‹œ
        if (!children) {
          children = document.createElement('div');
          children.className = 'tree-children';
          item.appendChild(children);
        }
        showLecturesInTree(item, name);
        children.classList.add('expanded');
        typeToggle.classList.remove('collapsed');
        typeToggle.classList.add('expanded');
      }
      document.querySelectorAll('.type-item').forEach(i => i.classList.remove('active'));
      header.classList.add('active');
    });
  } else {
    // ì¼ë°˜ ì•„ì´í…œ: í† ê¸€ ì•„ì´ì½˜ ì¶”ê°€
    const toggle = document.createElement('span');
    toggle.className = 'tree-toggle collapsed';
    
    const icon = document.createElement('span');
    icon.className = 'tree-icon';
    
    header.appendChild(toggle);
    header.appendChild(text);
    
    header.addEventListener('click', () => {
      const children = item.querySelector('.tree-children');
      if (children) {
        const isExpanded = children.classList.contains('expanded');
        if (isExpanded) {
          children.classList.remove('expanded');
          toggle.classList.remove('expanded');
          toggle.classList.add('collapsed');
        } else {
          children.classList.add('expanded');
          toggle.classList.remove('collapsed');
          toggle.classList.add('expanded');
          if (children.children.length === 0) {
            onClick();
          }
        }
      } else {
        onClick();
      }
    });
  }
  
  item.appendChild(header);
  return item;
}

function renderSubTree(parentItem, data, level) {
  let childrenContainer = parentItem.querySelector('.tree-children');
  if (!childrenContainer) {
    childrenContainer = document.createElement('div');
    childrenContainer.className = 'tree-children';
    parentItem.appendChild(childrenContainer);
  }
  
  if (level === 'middle') {
    Object.keys(data).forEach(middleUnit => {
      const middleItem = createTreeItem(middleUnit, 'middle', () => {
        renderSubTree(middleItem, data[middleUnit], 'minor');
      });
      childrenContainer.appendChild(middleItem);
    });
  } else if (level === 'minor') {
    Object.keys(data).forEach(minorUnit => {
      const minorItem = createTreeItem(minorUnit, 'minor', () => {
        renderSubTree(minorItem, data[minorUnit], 'type');
      });
      childrenContainer.appendChild(minorItem);
    });
  } else if (level === 'type') {
    data.forEach(typeName => {
      const typeItem = createTreeItem(typeName, 'type');
      childrenContainer.appendChild(typeItem);
    });
  }
  
  childrenContainer.classList.add('expanded');
  const toggle = parentItem.querySelector('.tree-toggle');
  toggle.classList.remove('collapsed');
  toggle.classList.add('expanded');
}

// ê°•ì˜ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
function getLectureCount(typeName) {
  const path = findTypePath(typeName);
  if (!path) return 0;
  const lectures = getLecturesByPath(path);
  return lectures ? lectures.length : 0;
}

// ìœ í˜• ê²½ë¡œ ì°¾ê¸°
function findTypePath(typeName) {
  if (!curriculumData) return null;
  
  for (const majorUnit in curriculumData) {
    for (const middleUnit in curriculumData[majorUnit]) {
      for (const minorUnit in curriculumData[majorUnit][middleUnit]) {
        const types = curriculumData[majorUnit][middleUnit][minorUnit];
        if (types.includes(typeName)) {
          return [majorUnit, middleUnit, minorUnit, typeName];
        }
      }
    }
  }
  return null;
}

// ê²½ë¡œë¡œ ê°•ì˜ ê°€ì ¸ì˜¤ê¸°
function getLecturesByPath(path) {
  const [major, middle, minor, type] = path;
  if (!lecturesData[major] || !lecturesData[major][middle] || 
      !lecturesData[major][middle][minor] || !lecturesData[major][middle][minor][type]) {
    return null;
  }
  return lecturesData[major][middle][minor][type];
}

// íŠ¸ë¦¬ ë‚´ì—ì„œ ê°•ì˜ ëª©ë¡ í‘œì‹œ
function showLecturesInTree(parentItem, typeName) {
  const path = findTypePath(typeName);
  if (!path) return;
  
  let childrenContainer = parentItem.querySelector('.tree-children');
  if (!childrenContainer) {
    childrenContainer = document.createElement('div');
    childrenContainer.className = 'tree-children';
    parentItem.appendChild(childrenContainer);
  }
  
  // ê¸°ì¡´ ì˜ìƒ ëª©ë¡ ì œê±°
  childrenContainer.innerHTML = '';
  
  const lectures = getLecturesByPath(path) || [];
  
  if (lectures.length === 0) {
    const emptyMsg = document.createElement('div');
    emptyMsg.style.cssText = 'padding: 8px 8px 8px 50px; color: #999; font-size: 12px; font-style: italic;';
    emptyMsg.textContent = 'ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.';
    childrenContainer.appendChild(emptyMsg);
  } else {
    lectures.forEach((lecture, index) => {
      const item = document.createElement('div');
      item.className = 'lecture-item';
      item.dataset.index = index;
      item.dataset.typeName = typeName;
      
      const titleSpan = document.createElement('span');
      titleSpan.className = 'lecture-item-title';
      titleSpan.textContent = lecture.title;
      
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-lecture-btn';
      deleteBtn.textContent = 'ì‚­ì œ';
      deleteBtn.dataset.index = index;
      
      item.appendChild(titleSpan);
      item.appendChild(deleteBtn);
      
      titleSpan.addEventListener('click', (e) => {
        e.stopPropagation();
        playVideo(lecture.url);
        document.querySelectorAll('.lecture-item').forEach(i => i.classList.remove('playing'));
        item.classList.add('playing');
      });
      
      deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm('ì´ ê°•ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          deleteLecture(path, index, typeName);
        }
      });
      
      childrenContainer.appendChild(item);
    });
  }
}

// ê°•ì˜ ëª©ë¡ í‘œì‹œ (í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ìš© - í˜¸í™˜ì„± ìœ ì§€)
function showLectures(typeName) {
  const path = findTypePath(typeName);
  if (!path) return;
  
  const lectures = getLecturesByPath(path) || [];
  const listTitle = document.getElementById('lectureListTitle');
  const listContent = document.getElementById('lectureListContent');
  const listContainer = document.getElementById('lectureList');
  
  listTitle.textContent = `${typeName} (${lectures.length}ê°œ)`;
  listContent.innerHTML = '';
  
  if (lectures.length === 0) {
    listContent.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">ê°•ì˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  } else {
    lectures.forEach((lecture, index) => {
      const item = document.createElement('div');
      item.className = 'lecture-item';
      item.innerHTML = `
        <span>${lecture.title}</span>
        <button class="delete-lecture-btn" data-index="${index}">ì‚­ì œ</button>
      `;
      
      item.querySelector('span').addEventListener('click', () => {
        playVideo(lecture.url);
        document.querySelectorAll('.lecture-item').forEach(i => i.classList.remove('playing'));
        item.classList.add('playing');
      });
      
      item.querySelector('.delete-lecture-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm('ì´ ê°•ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          deleteLecture(path, index, typeName);
        }
      });
      
      listContent.appendChild(item);
    });
  }
  
  listContainer.classList.add('visible');
}

// ê°•ì˜ ì‚­ì œ
function deleteLecture(path, index, typeName) {
  const [major, middle, minor, type] = path;
  if (!lecturesData[major] || !lecturesData[major][middle] || 
      !lecturesData[major][middle][minor] || !lecturesData[major][middle][minor][type]) {
    return;
  }
  
  lecturesData[major][middle][minor][type].splice(index, 1);
  
  // ë²ˆí˜¸ ì¬ì •ë ¬ (ì„ íƒì‚¬í•­ - í•„ìš”í•˜ë©´ ì£¼ì„ í•´ì œ)
  // lecturesData[major][middle][minor][type].forEach((lecture, idx) => {
  //   lecture.title = `${type} ${idx + 1}`;
  // });
  
  saveData();
  
  // íŠ¸ë¦¬ ë‚´ ì˜ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
  const typeItem = Array.from(document.querySelectorAll('.type-item')).find(item => {
    return item.textContent.includes(typeName) && !item.textContent.includes('(');
  });
  if (typeItem) {
    const treeItem = typeItem.closest('.tree-item');
    if (treeItem) {
      const children = treeItem.querySelector('.tree-children');
      if (children && children.classList.contains('expanded')) {
        showLecturesInTree(treeItem, typeName);
      }
    }
  }
  
  // í•˜ë‹¨ ë¦¬ìŠ¤íŠ¸ë„ ì—…ë°ì´íŠ¸ (í‘œì‹œ ì¤‘ì¸ ê²½ìš°)
  const listContainer = document.getElementById('lectureList');
  if (listContainer && listContainer.classList.contains('visible')) {
    showLectures(typeName);
  }
  
  renderTree(); // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
}

// ìë™ ë§¤ì¹­: ë¼ìš´ë“œ ë¡œë¹ˆ ë°©ì‹ (ìˆœì„œëŒ€ë¡œ 3ê°œì”©)
function autoMatchLectures(newVideos) {
  // ëª¨ë“  ìœ í˜• ê²½ë¡œ ìˆ˜ì§‘ (ìˆœì„œ ìœ ì§€)
  const allTypes = [];
  if (!curriculumData) return [];
  
  for (const majorUnit in curriculumData) {
    for (const middleUnit in curriculumData[majorUnit]) {
      for (const minorUnit in curriculumData[majorUnit][middleUnit]) {
        const types = curriculumData[majorUnit][middleUnit][minorUnit];
        types.forEach(typeName => {
          allTypes.push([majorUnit, middleUnit, minorUnit, typeName]);
        });
      }
    }
  }
  
  // ê° ìœ í˜•ì˜ ê°•ì˜ ê°œìˆ˜ ê³„ì‚°
  const typeCounts = allTypes.map((path, index) => {
    const lectures = getLecturesByPath(path);
    return {
      path,
      index, // ì›ë˜ ìˆœì„œ ë³´ì¡´
      count: lectures ? lectures.length : 0
    };
  });
  
  // ê°•ì˜ë¥¼ ìˆœì„œëŒ€ë¡œ í• ë‹¹
  newVideos.forEach(video => {
    // ê°€ì¥ ì ì€ ê°œìˆ˜ë¥¼ ê°€ì§„ ìœ í˜• ì°¾ê¸° (ê°œìˆ˜ê°€ ê°™ìœ¼ë©´ ì›ë˜ ìˆœì„œëŒ€ë¡œ)
    typeCounts.sort((a, b) => {
      if (a.count !== b.count) return a.count - b.count;
      return a.index - b.index; // ì›ë˜ ìˆœì„œ ìœ ì§€
    });
    
    const targetType = typeCounts[0];
    const [major, middle, minor, type] = targetType.path;
    
    // ê°•ì˜ ë°ì´í„° êµ¬ì¡° ì´ˆê¸°í™”
    if (!lecturesData[major]) lecturesData[major] = {};
    if (!lecturesData[major][middle]) lecturesData[major][middle] = {};
    if (!lecturesData[major][middle][minor]) lecturesData[major][middle][minor] = {};
    if (!lecturesData[major][middle][minor][type]) lecturesData[major][middle][minor][type] = [];
    
    // ê°•ì˜ ì¶”ê°€ (ìœ í˜•ëª… + ë²ˆí˜¸)
    const lectureCount = lecturesData[major][middle][minor][type].length;
    const lectureTitle = `${type} ${lectureCount + 1}`;
    
    lecturesData[major][middle][minor][type].push({
      title: lectureTitle,
      url: video.url
    });
    
    // ì¹´ìš´íŠ¸ ì¦ê°€
    targetType.count++;
  });
}

// ë°ì´í„° ì €ì¥
function saveData() {
  localStorage.setItem(`mathflat_${currentGrade}`, JSON.stringify({
    curriculum: curriculumData,
    lectures: lecturesData
  }));
  
  // í•™ë…„-í•™ê¸° ëª©ë¡ ì—…ë°ì´íŠ¸
  if (currentGrade && !availableGrades.includes(currentGrade)) {
    availableGrades.push(currentGrade);
    availableGrades.sort();
    renderGradeButtons();
  }
}

// ë¹„ë””ì˜¤ ì¬ìƒ
const video = document.getElementById('videoPlayer');
function playVideo(videoSrc) {
  if (Hls.isSupported()) {
    const hls = new Hls();
    hls.loadSource(videoSrc);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play();
    });
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = videoSrc;
    video.addEventListener('loadedmetadata', () => {
      video.play();
    });
  }
}

// í•™ë…„ ì„ íƒì€ renderGradeButtonsì—ì„œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¡œ ì²˜ë¦¬ë¨

// ëª¨ë‹¬ ê´€ë¦¬
const addBtn = document.getElementById('addBtn');
const modal = document.getElementById('addModal');
const closeModal = document.getElementById('closeModal');
const cancelBtn = document.getElementById('cancelBtn');
const saveBtn = document.getElementById('saveBtn');
const jsonInput = document.getElementById('jsonInput');

addBtn.onclick = () => {
  modal.style.display = 'block';
  jsonInput.value = '';
  jsonInput.focus();
};

closeModal.onclick = () => {
  modal.style.display = 'none';
};

cancelBtn.onclick = () => {
  modal.style.display = 'none';
};

saveBtn.onclick = () => {
  const jsonText = jsonInput.value.trim();
  if (!jsonText) {
    alert('JSONì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    const newVideos = JSON.parse(jsonText);
    if (!Array.isArray(newVideos)) {
      throw new Error('ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
    }
    
    // URLë§Œ ì¶”ì¶œ (ì œëª©ì€ ìë™ ìƒì„±)
    const videosWithUrl = newVideos.filter(v => v.url);
    
    if (videosWithUrl.length === 0) {
      alert('ìœ íš¨í•œ URLì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    // ìë™ ë§¤ì¹­
    autoMatchLectures(videosWithUrl);
    saveData();
    renderTree();
    alert(`âœ… ${videosWithUrl.length}ê°œ ê°•ì˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    modal.style.display = 'none';
  } catch (e) {
    alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ' + e.message);
  }
};

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = (event) => {
  if (event.target === modal) {
    modal.style.display = 'none';
  }
};

// í™”ë©´ ì „í™˜
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const screen = btn.dataset.screen;
    
    // íƒ­ ë²„íŠ¼ í™œì„±í™”
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    if (screen === 'lectures') {
      document.getElementById('lecturesPanel').style.display = 'flex';
      document.getElementById('rightPanel').style.display = 'flex';
      document.getElementById('settingsScreen').classList.remove('active');
    } else if (screen === 'settings') {
      document.getElementById('lecturesPanel').style.display = 'none';
      document.getElementById('rightPanel').style.display = 'none';
      document.getElementById('settingsScreen').classList.add('active');
      // ì»¤ë¦¬í˜ëŸ¼ JSON ë¡œë“œ
      if (curriculumData) {
        document.getElementById('curriculumJsonInput').value = JSON.stringify(curriculumData, null, 2);
      }
    }
  });
});

// ì„¤ì • ë©”ë‰´ ì „í™˜
document.querySelectorAll('.settings-menu-item').forEach(item => {
  item.addEventListener('click', () => {
    const setting = item.dataset.setting;
    
    // ë©”ë‰´ í™œì„±í™”
    document.querySelectorAll('.settings-menu-item').forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    
    // íŒ¨ë„ í‘œì‹œ
    document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(`${setting}-panel`).classList.add('active');
  });
});

// ì„¤ì •ì—ì„œ ê°•ì˜ ì¶”ê°€
document.getElementById('settingsAddBtn').addEventListener('click', () => {
  const jsonText = document.getElementById('settingsJsonInput').value.trim();
  if (!jsonText) {
    alert('JSONì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    const newVideos = JSON.parse(jsonText);
    if (!Array.isArray(newVideos)) {
      throw new Error('ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
    }
    
    const videosWithUrl = newVideos.filter(v => v.url);
    
    if (videosWithUrl.length === 0) {
      alert('ìœ íš¨í•œ URLì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }
    
    autoMatchLectures(videosWithUrl);
    saveData();
    renderTree();
    alert(`âœ… ${videosWithUrl.length}ê°œ ê°•ì˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    document.getElementById('settingsJsonInput').value = '';
  } catch (e) {
    alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ' + e.message);
  }
});

// ì»¤ë¦¬í˜ëŸ¼ ì €ì¥
document.getElementById('curriculumSaveBtn').addEventListener('click', () => {
  const jsonText = document.getElementById('curriculumJsonInput').value.trim();
  if (!jsonText) {
    alert('JSONì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  try {
    const newCurriculum = JSON.parse(jsonText);
    curriculumData = newCurriculum;
    saveData();
    renderTree();
    alert('âœ… ì»¤ë¦¬í˜ëŸ¼ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch (e) {
    alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ' + e.message);
  }
});

// ì»¤ë¦¬í˜ëŸ¼ ì´ˆê¸°í™”
document.getElementById('curriculumResetBtn').addEventListener('click', () => {
  if (confirm('ì›ë³¸ íŒŒì¼ì—ì„œ ì»¤ë¦¬í˜ëŸ¼ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    localStorage.removeItem(`mathflat_${currentGrade}`);
    loadGradeData(currentGrade);
    document.getElementById('curriculumJsonInput').value = JSON.stringify(curriculumData, null, 2);
    alert('âœ… ì»¤ë¦¬í˜ëŸ¼ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
});

// ì´ˆê¸°í™”
renderGradeButtons();
</script>

</body>
</html>
